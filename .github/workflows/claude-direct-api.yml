name: Claude Direct API

on:
  repository_dispatch:
    types: [claude-bug-analysis]

jobs:
  analyze-with-claude:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # Create prompt for Claude
      - name: Create Claude Prompt
        id: create_prompt
        run: |
          echo "Creating prompt for Claude with bug details"
          # Save the prompt to a file
          cat << EOF > claude_prompt.txt
          You are a senior iOS developer working on a Netflix clone app. A bug has been reported:

          **Bug Title:** ${{ github.event.client_payload.title }}
          **Bug Description:** ${{ github.event.client_payload.description }}

          Please analyze this bug and provide:
          1. **Root Cause Analysis** - What likely causes this issue?
          2. **Code Location** - Which files/functions are probably involved?
          3. **Fix Implementation** - Specific code changes needed
          4. **Testing Strategy** - How to verify the fix works
          
          Focus on iOS, Swift and UIKit best practices.
          EOF
          
          echo "Prompt created:"
          cat claude_prompt.txt
      
      # Call Claude API directly
      - name: Call Claude API
        id: claude_api
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Prepare request data
          echo "Calling Claude API directly..."
          
          # Read the prompt from file
          PROMPT=$(cat claude_prompt.txt)
          
          # Create JSON request data
          JSON_DATA=$(cat << EOF
          {
            "model": "claude-sonnet-4-20250514",
            "messages": [
              {
                "role": "system",
                "content": "You are a precise and helpful iOS developer specialized in Swift and UIKit. You analyze bugs in code and provide clear, actionable solutions with code examples."
              },
              {
                "role": "user",
                "content": "$PROMPT"
              }
            ],
            "max_tokens": 4000,
            "temperature": 0.2
          }
          EOF
          )
          
          # Call the API
          RESPONSE=$(curl -s -X POST \
            https://eng-ai-model-gateway.sfproxy.devx-preprod.aws-esvc1-useast2.aws.sfdc.cl/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANTHROPIC_API_KEY" \
            -d "$JSON_DATA")
          
          # Extract Claude's response
          CLAUDE_CONTENT=$(echo $RESPONSE | jq -r '.choices[0].message.content')
          
          # Save response to file
          echo "$CLAUDE_CONTENT" > claude_analysis.md
          
          echo "Claude API response saved to claude_analysis.md"
          
          # Save a short preview for the output
          echo "$CLAUDE_CONTENT" | head -n 20 > claude_preview.txt
      
      # Create an issue with Claude's analysis
      - name: Create GitHub Issue with Analysis
        id: create_issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read Claude's analysis
            const analysis = fs.readFileSync('claude_analysis.md', 'utf8');
            
            // Create issue with analysis
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🐛 Bug Analysis: ${{ github.event.client_payload.title }}`,
              body: `## Bug Report
              
              **Title:** ${{ github.event.client_payload.title }}
              **Description:** ${{ github.event.client_payload.description }}
              
              ## Claude's Analysis
              
              ${analysis}
              
              ---
              *This analysis was generated automatically by Claude AI via direct API call.*
              `
            });
            
            console.log(`Issue created: ${issue.data.html_url}`);
            
            // Store the issue number and URL for later use
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);
      
      # Create a summary
      - name: Create Summary
        run: |
          echo "## 🤖 Bug Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🐛 **Bug Title:** ${{ github.event.client_payload.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📝 **Bug Description:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.client_payload.description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔗 **Issue Created:** [#${{ steps.create_issue.outputs.issue_number }}](${{ steps.create_issue.outputs.issue_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "💡 **Analysis Preview:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat claude_preview.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY